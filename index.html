<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>MedLib AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #0f0f1a);
            color: var(--tg-theme-text-color, #ffffff);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MENU STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .menu-view {
            display: none;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .menu-view.active {
            display: block;
        }
        
        .menu-header {
            padding: 20px 16px 16px;
            text-align: center;
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.15) 0%, 
                rgba(118, 75, 162, 0.15) 100%);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-logo {
            font-size: 48px;
            margin-bottom: 8px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .menu-header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .menu-header p {
            font-size: 13px;
            opacity: 0.6;
            margin-top: 4px;
        }
        
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 16px;
            margin: 12px 16px;
            background: var(--tg-theme-secondary-bg-color, #1a1a2e);
            border-radius: 16px;
        }
        
        .stat {
            text-align: center;
            min-width: 60px;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 2px;
        }
        
        .menu-container {
            padding: 0 16px 100px;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.4;
            margin: 20px 0 12px 4px;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .menu-card {
            background: var(--tg-theme-secondary-bg-color, #1a1a2e);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--card-color, #667eea), transparent);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .menu-card:active {
            transform: scale(0.97);
            border-color: rgba(102, 126, 234, 0.3);
        }
        
        .menu-card:active::before {
            opacity: 1;
        }
        
        .card-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .card-desc {
            font-size: 11px;
            opacity: 0.5;
            line-height: 1.3;
        }
        
        .menu-card.featured {
            grid-column: span 2;
            display: flex;
            align-items: center;
            gap: 16px;
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.2) 0%, 
                rgba(118, 75, 162, 0.2) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .menu-card.featured .card-icon {
            font-size: 40px;
            margin-bottom: 0;
        }
        
        .menu-card.featured .card-content {
            flex: 1;
        }
        
        .badge-new {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: #fff;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 6px;
            text-transform: uppercase;
        }
        
        .quick-actions {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0 12px;
            -webkit-overflow-scrolling: touch;
        }
        
        .quick-actions::-webkit-scrollbar {
            display: none;
        }
        
        .quick-btn {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: var(--tg-theme-secondary-bg-color, #1a1a2e);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .quick-btn:active {
            transform: scale(0.95);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 10px 8px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            background: var(--tg-theme-secondary-bg-color, #1a1a2e);
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.5;
        }
        
        .nav-item.active {
            opacity: 1;
            background: rgba(102, 126, 234, 0.15);
        }
        
        .nav-item:active {
            opacity: 1;
        }
        
        .nav-item .icon {
            font-size: 22px;
        }
        
        .nav-item .label {
            font-size: 10px;
            font-weight: 500;
        }
        
        /* Card colors */
        .menu-card[data-color="blue"] { --card-color: #3b82f6; }
        .menu-card[data-color="purple"] { --card-color: #8b5cf6; }
        .menu-card[data-color="pink"] { --card-color: #ec4899; }
        .menu-card[data-color="green"] { --card-color: #10b981; }
        .menu-card[data-color="orange"] { --card-color: #f59e0b; }
        .menu-card[data-color="red"] { --card-color: #ef4444; }
        .menu-card[data-color="cyan"] { --card-color: #06b6d4; }
        
        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .menu-card {
            animation: fadeInUp 0.4s ease backwards;
        }
        
        .menu-card:nth-child(1) { animation-delay: 0.05s; }
        .menu-card:nth-child(2) { animation-delay: 0.1s; }
        .menu-card:nth-child(3) { animation-delay: 0.15s; }
        .menu-card:nth-child(4) { animation-delay: 0.2s; }
        .menu-card:nth-child(5) { animation-delay: 0.25s; }
        .menu-card:nth-child(6) { animation-delay: 0.3s; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ATLAS STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .atlas-view {
            display: none;
        }
        
        .atlas-view.active {
            display: block;
        }
        
        .header {
            padding: 12px 16px;
            text-align: center;
            background: var(--tg-theme-secondary-bg-color, #16213e);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .header h1 {
            font-size: 16px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 2px;
        }
        
        .atlas-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 12px;
        }
        
        .image-wrapper {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            background: #000;
        }
        
        .atlas-image {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .point {
            position: absolute;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .point:hover, .point:active {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
        }
        
        .point.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: translate(-50%, -50%) scale(1.3);
            animation: none;
            box-shadow: 0 0 25px rgba(240, 147, 251, 0.8);
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(102, 126, 234, 0); }
        }
        
        .point-number {
            font-size: 11px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .info-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-secondary-bg-color, #16213e);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.4);
            max-height: 55vh;
            overflow-y: auto;
        }
        
        .info-panel.visible {
            transform: translateY(0);
        }
        
        .info-panel .handle {
            width: 36px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 0 auto 16px;
        }
        
        .info-panel .point-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .info-panel .title-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .info-panel .ru-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-theme-text-color, #fff);
            line-height: 1.2;
        }
        
        .info-panel .lat-name {
            font-size: 15px;
            font-style: italic;
            opacity: 0.8;
            margin-bottom: 12px;
            color: #a78bfa;
            padding-left: 44px;
        }
        
        .info-panel .description {
            font-size: 14px;
            line-height: 1.5;
            opacity: 0.9;
            padding-left: 44px;
            padding-right: 40px;
        }
        
        .info-panel .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .info-panel .close-btn:hover,
        .info-panel .close-btn:active {
            background: rgba(255,255,255,0.2);
        }
        
        .legend {
            margin-top: 16px;
            padding: 12px;
            background: var(--tg-theme-secondary-bg-color, #16213e);
            border-radius: 12px;
        }
        
        .legend h3 {
            font-size: 13px;
            opacity: 0.7;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            padding: 8px 6px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px;
            margin: 2px -6px;
        }
        
        .legend-item:hover,
        .legend-item:active {
            background: rgba(255,255,255,0.05);
        }
        
        .legend-item:last-child {
            border-bottom: none;
        }
        
        .legend-item .num {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .legend-item .text {
            flex: 1;
            min-width: 0;
        }
        
        .legend-item .ru {
            font-size: 13px;
            font-weight: 500;
        }
        
        .legend-item .lat {
            font-size: 11px;
            opacity: 0.6;
            font-style: italic;
        }
        
        .nav-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-btn {
            flex: 1;
            padding: 12px;
            background: rgba(102, 126, 234, 0.2);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .nav-btn:hover:not(:disabled),
        .nav-btn:active:not(:disabled) {
            background: rgba(102, 126, 234, 0.4);
        }
        
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 50;
        }
        
        .overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: 20px;
        }
        
        .error .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .error p {
            font-size: 16px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <!-- Atlas overlay and panel (always present) -->
    <div class="overlay" id="overlay"></div>
    <div class="info-panel" id="infoPanel">
        <div class="handle"></div>
        <button class="close-btn" onclick="closePanel()">âœ•</button>
        <div class="title-row">
            <span class="point-badge" id="infoBadge">1</span>
            <span class="ru-name" id="infoRu">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</span>
        </div>
        <div class="lat-name" id="infoLat">Ğ›Ğ°Ñ‚Ğ¸Ğ½ÑĞºĞ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</div>
        <div class="description" id="infoDesc">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹...</div>
        <div class="nav-buttons">
            <button class="nav-btn" id="prevBtn" onclick="showPrev()">â† ĞĞ°Ğ·Ğ°Ğ´</button>
            <button class="nav-btn" id="nextBtn" onclick="showNext()">Ğ”Ğ°Ğ»ĞµĞµ â†’</button>
        </div>
    </div>
    
    <script>
        const tg = window.Telegram?.WebApp;
        
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Telegram WebApp
        if (tg) {
            tg.ready();
            tg.expand();
        }
        
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ URL
        const params = new URLSearchParams(window.location.search);
        const imgUrl = params.get('img');
        const b64Data = params.get('b64');
        const jsonData = params.get('data');
        const userData = params.get('user');
        
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼: Ğ¼ĞµĞ½Ñ Ğ¸Ğ»Ğ¸ Ğ°Ñ‚Ğ»Ğ°Ñ
        const isAtlasMode = jsonData && (imgUrl || b64Data);
        
        let points = [];
        let activePointIndex = -1;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function init() {
            if (isAtlasMode) {
                initAtlas();
            } else {
                initMenu();
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MENU MODE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function initMenu() {
            // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
            let userStats = { files: 156, xp: 450, streak: 5 };
            if (userData) {
                try {
                    userStats = JSON.parse(decodeURIComponent(userData));
                } catch(e) {}
            }
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="menu-view active">
                    <div class="menu-header">
                        <div class="menu-logo">ğŸ¥</div>
                        <h1>MedLib AI</h1>
                        <p>Ğ¢Ğ²Ğ¾Ğ¹ ÑƒĞ¼Ğ½Ñ‹Ğ¹ Ğ¼ĞµĞ´Ğ¸Ñ†Ğ¸Ğ½ÑĞºĞ¸Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº</p>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stat">
                            <div class="stat-value" id="filesCount">${userStats.files || 0}</div>
                            <div class="stat-label">ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ²</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="xpCount">${userStats.xp || 0}</div>
                            <div class="stat-label">XP</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="streakCount">${userStats.streak || 0}</div>
                            <div class="stat-label">ğŸ”¥ Ğ¡Ñ‚Ñ€Ğ¸Ğº</div>
                        </div>
                    </div>
                    
                    <div class="menu-container">
                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <div class="quick-btn" onclick="sendAction('search')">
                                <span>ğŸ”</span><span>ĞŸĞ¾Ğ¸ÑĞº</span>
                            </div>
                            <div class="quick-btn" onclick="sendAction('ai')">
                                <span>ğŸ¤–</span><span>AI Ñ‡Ğ°Ñ‚</span>
                            </div>
                            <div class="quick-btn" onclick="sendAction('voice')">
                                <span>ğŸ¤</span><span>Ğ“Ğ¾Ğ»Ğ¾Ñ</span>
                            </div>
                            <div class="quick-btn" onclick="sendAction('video')">
                                <span>ğŸ¬</span><span>Ğ’Ğ¸Ğ´ĞµĞ¾</span>
                            </div>
                        </div>
                        
                        <!-- Learning -->
                        <div class="section-title">ğŸ“š ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ</div>
                        <div class="menu-grid">
                            <div class="menu-card featured" data-color="purple" onclick="sendAction('study')">
                                <div class="card-icon">ğŸ“</div>
                                <div class="card-content">
                                    <div class="card-title">ĞšĞ¾Ğ½ÑĞ¿ĞµĞºÑ‚ Ğ¿Ğ¾ Ñ‚ĞµĞ¼Ğµ</div>
                                    <div class="card-desc">AI ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»</div>
                                </div>
                            </div>
                            
                            <div class="menu-card" data-color="blue" onclick="sendAction('quiz')">
                                <span class="badge-new">NEW</span>
                                <div class="card-icon">ğŸ¯</div>
                                <div class="card-title">Ğ¢ĞµÑÑ‚Ñ‹</div>
                                <div class="card-desc">AI Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹</div>
                            </div>
                            
                            <div class="menu-card" data-color="green" onclick="sendAction('cards')">
                                <span class="badge-new">NEW</span>
                                <div class="card-icon">ğŸ“š</div>
                                <div class="card-title">ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸</div>
                                <div class="card-desc">Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ĞµĞ½Ğ¸Ğµ</div>
                            </div>
                            
                            <div class="menu-card" data-color="cyan" onclick="sendAction('interactive')">
                                <div class="card-icon">ğŸ§ </div>
                                <div class="card-title">Ğ˜Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²</div>
                                <div class="card-desc">Ğ£Ñ‡Ğ¸ÑÑŒ Ğ¸Ğ³Ñ€Ğ°Ñ</div>
                            </div>
                            
                            <div class="menu-card" data-color="orange" onclick="sendAction('atlas')">
                                <div class="card-icon">ğŸ–¼</div>
                                <div class="card-title">ĞÑ‚Ğ»Ğ°Ñ</div>
                                <div class="card-desc">ĞĞ½Ğ°Ñ‚Ğ¾Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑÑ…ĞµĞ¼Ñ‹</div>
                            </div>
                        </div>
                        
                        <!-- Create -->
                        <div class="section-title">âœ¨ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</div>
                        <div class="menu-grid">
                            <div class="menu-card" data-color="pink" onclick="sendAction('pptx')">
                                <div class="card-icon">ğŸ¨</div>
                                <div class="card-title">ĞŸÑ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ</div>
                                <div class="card-desc">Canva-Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½ Ğ·Ğ° Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ</div>
                            </div>
                            
                            <div class="menu-card" data-color="purple" onclick="sendAction('multi')">
                                <div class="card-icon">ğŸ“‘</div>
                                <div class="card-title">Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ</div>
                                <div class="card-desc">ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹</div>
                            </div>
                        </div>
                        
                        <!-- Library -->
                        <div class="section-title">ğŸ“– Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ°</div>
                        <div class="menu-grid">
                            <div class="menu-card" data-color="blue" onclick="sendAction('catalog')">
                                <div class="card-icon">ğŸ“š</div>
                                <div class="card-title">ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³</div>
                                <div class="card-desc">Ğ’ÑĞµ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹</div>
                            </div>
                            
                            <div class="menu-card" data-color="orange" onclick="sendAction('favorites')">
                                <div class="card-icon">â­</div>
                                <div class="card-title">Ğ˜Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ</div>
                                <div class="card-desc">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ğ¾Ğµ</div>
                            </div>
                            
                            <div class="menu-card" data-color="green" onclick="sendAction('schedule')">
                                <div class="card-icon">ğŸ—“</div>
                                <div class="card-title">Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</div>
                                <div class="card-desc">Ğ—Ğ°Ğ½ÑÑ‚Ğ¸Ñ</div>
                            </div>
                            
                            <div class="menu-card" data-color="red" onclick="sendAction('news')">
                                <div class="card-icon">ğŸ“¢</div>
                                <div class="card-title">ĞĞ¾Ğ²Ğ¾ÑÑ‚Ğ¸</div>
                                <div class="card-desc">ĞĞ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ñ</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Nav -->
                    <div class="bottom-nav">
                        <div class="nav-item active" onclick="sendAction('home')">
                            <span class="icon">ğŸ </span>
                            <span class="label">Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</span>
                        </div>
                        <div class="nav-item" onclick="sendAction('search')">
                            <span class="icon">ğŸ”</span>
                            <span class="label">ĞŸĞ¾Ğ¸ÑĞº</span>
                        </div>
                        <div class="nav-item" onclick="sendAction('ai')">
                            <span class="icon">ğŸ¤–</span>
                            <span class="label">AI</span>
                        </div>
                        <div class="nav-item" onclick="sendAction('profile')">
                            <span class="icon">ğŸ†</span>
                            <span class="label">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span>
                        </div>
                    </div>
                </div>
            `;
            
            // ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ñ‡Ğ¸ÑĞµĞ»
            setTimeout(() => animateNumbers(userStats), 300);
        }
        
        function sendAction(action) {
            // Haptic feedback
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
            
            // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ±Ğ¾Ñ‚ Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ WebApp
            if (tg && tg.sendData) {
                tg.sendData(JSON.stringify({ action: action }));
                // WebApp Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ·Ğ°ĞºÑ€Ğ¾ĞµÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ sendData
            } else {
                console.log('Action:', action);
                alert('Telegram WebApp Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½. Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: ' + action);
            }
        }
        
        function animateNumbers(stats) {
            animateNumber('filesCount', stats.files || 156);
            animateNumber('xpCount', stats.xp || 450);
            animateNumber('streakCount', stats.streak || 5);
        }
        
        function animateNumber(id, target) {
            const el = document.getElementById(id);
            if (!el) return;
            
            let current = 0;
            const step = Math.ceil(target / 20);
            const interval = setInterval(() => {
                current += step;
                if (current >= target) {
                    current = target;
                    clearInterval(interval);
                }
                el.textContent = current;
            }, 30);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ATLAS MODE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function initAtlas() {
            try {
                points = JSON.parse(decodeURIComponent(jsonData));
                if (!Array.isArray(points) || points.length === 0) {
                    showError('Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹');
                    return;
                }
                renderAtlas();
            } catch (e) {
                console.error('Parse error:', e);
                showError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…');
            }
        }
        
        function getImageSrc() {
            if (imgUrl) return decodeURIComponent(imgUrl);
            if (b64Data) {
                const decoded = decodeURIComponent(b64Data);
                if (decoded.startsWith('/9j/')) return `data:image/jpeg;base64,${decoded}`;
                if (decoded.startsWith('iVBOR')) return `data:image/png;base64,${decoded}`;
                if (decoded.startsWith('R0lGOD')) return `data:image/gif;base64,${decoded}`;
                return `data:image/jpeg;base64,${decoded}`;
            }
            return '';
        }
        
        function renderAtlas() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="atlas-view active">
                    <div class="header">
                        <h1>ğŸ§  ĞĞ½Ğ°Ñ‚Ğ¾Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ĞÑ‚Ğ»Ğ°Ñ</h1>
                        <p>ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚ĞµĞ¹</p>
                    </div>
                    <div class="atlas-container">
                        <div class="image-wrapper" id="imageWrapper">
                            <img src="${getImageSrc()}" class="atlas-image" id="atlasImage" 
                                 onload="onImageLoad()" onerror="onImageError()" 
                                 alt="ĞĞ½Ğ°Ñ‚Ğ¾Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑ…ĞµĞ¼Ğ°">
                        </div>
                        <div class="legend" id="legend">
                            <h3>ğŸ“‹ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ½Ğ° ÑÑ…ĞµĞ¼Ğµ (${points.length}):</h3>
                            <div id="legendItems"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function onImageLoad() {
            const wrapper = document.getElementById('imageWrapper');
            const legendItems = document.getElementById('legendItems');
            
            points.forEach((point, index) => {
                // Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ½Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸
                const dot = document.createElement('div');
                dot.className = 'point';
                dot.id = `point-${index}`;
                
                const xPercent = (point.x / 10).toFixed(2);
                const yPercent = (point.y / 10).toFixed(2);
                
                dot.style.left = xPercent + '%';
                dot.style.top = yPercent + '%';
                dot.innerHTML = `<span class="point-number">${index + 1}</span>`;
                dot.onclick = (e) => {
                    e.stopPropagation();
                    showInfo(index);
                };
                wrapper.appendChild(dot);
                
                // Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ»ĞµĞ³ĞµĞ½Ğ´Ñ‹
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.id = `legend-${index}`;
                item.innerHTML = `
                    <span class="num">${index + 1}</span>
                    <div class="text">
                        <div class="ru">${escapeHtml(point.ru || 'Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°')}</div>
                        <div class="lat">${escapeHtml(point.lat || '')}</div>
                    </div>
                `;
                item.onclick = () => showInfo(index);
                legendItems.appendChild(item);
            });
        }
        
        function onImageError() {
            showError('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ');
        }
        
        function showInfo(index) {
            const point = points[index];
            if (!point) return;
            
            activePointIndex = index;
            
            document.querySelectorAll('.point').forEach((p, i) => {
                p.classList.toggle('active', i === index);
            });
            
            document.querySelectorAll('.legend-item').forEach((item, i) => {
                item.style.background = i === index ? 'rgba(102, 126, 234, 0.2)' : '';
            });
            
            document.getElementById('infoBadge').textContent = index + 1;
            document.getElementById('infoRu').textContent = point.ru || 'Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°';
            document.getElementById('infoLat').textContent = point.lat || '';
            document.getElementById('infoDesc').textContent = point.desc || 'ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚';
            
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === points.length - 1;
            
            document.getElementById('infoPanel').classList.add('visible');
            document.getElementById('overlay').classList.add('visible');
            
            const legendItem = document.getElementById(`legend-${index}`);
            if (legendItem) {
                legendItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }
        
        function showPrev() {
            if (activePointIndex > 0) showInfo(activePointIndex - 1);
        }
        
        function showNext() {
            if (activePointIndex < points.length - 1) showInfo(activePointIndex + 1);
        }
        
        function closePanel() {
            document.getElementById('infoPanel').classList.remove('visible');
            document.getElementById('overlay').classList.remove('visible');
            document.querySelectorAll('.point').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.legend-item').forEach(item => item.style.background = '');
            activePointIndex = -1;
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        // Event listeners Ğ´Ğ»Ñ Ğ°Ñ‚Ğ»Ğ°ÑĞ°
        document.getElementById('overlay').onclick = closePanel;
        
        let touchStartY = 0;
        document.getElementById('infoPanel').addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        });
        
        document.getElementById('infoPanel').addEventListener('touchmove', (e) => {
            const touchY = e.touches[0].clientY;
            if (touchY - touchStartY > 50) closePanel();
        });
        
        document.addEventListener('keydown', (e) => {
            if (activePointIndex === -1) return;
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') showPrev();
            else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') showNext();
            else if (e.key === 'Escape') closePanel();
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error">
                    <div class="icon">ğŸ˜•</div>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Ğ—Ğ°Ğ¿ÑƒÑĞº!
        init();
    </script>
</body>
</html>
